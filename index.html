<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¾å°„æ²»ç™‚ç‰©ç†åŸç†è¦–è¦ºåŒ–ï¼šå…‰å­ vs. è³ªå­ (å›ºå®šç‰ˆé¢)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #f4f7f6;
            --text-color: #333;
            --accent-blue: #3498db;
            --accent-red: #e74c3c;
            --accent-green: #2ecc71;
            --accent-orange: #e67e22;
            --panel-bg: #ffffff;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-sizing: border-box;
            
            /* --- æ–¹æ³•äºŒï¼šå¼·åˆ¶å›ºå®šå¯¬åº¦ï¼Œé˜²æ­¢è·‘ç‰ˆ --- */
            min-width: 1100px; /* å¼·åˆ¶ç¶²é è‡³å°‘ 1100px å¯¬ */
            overflow-x: auto;  /* å¯¬åº¦ä¸è¶³æ™‚é¡¯ç¤ºå·¦å³æ²è»¸ */
            /* ----------------------------------- */
        }

        h1 {
            text-align: center;
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 1.5rem;
        }

        .container {
            display: flex;
            flex: 1;
            gap: 20px;
            min-height: 0;
        }

        /* å·¦å´é¢æ¿ */
        .sidebar {
            flex: 1;
            background: var(--panel-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            min-width: 300px;
        }

        .theory-section h2, .control-section h2 {
            color: #2c3e50;
            border-bottom: 2px solid #eee;
            padding-bottom: 8px;
            margin-top: 0;
            font-size: 1.2rem;
        }

        .theory-block {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .xray-block { background-color: rgba(52, 152, 219, 0.1); border-left: 4px solid var(--accent-blue); }
        .proton-block { background-color: rgba(231, 76, 60, 0.1); border-left: 4px solid var(--accent-red); }

        .formula {
            font-family: 'Times New Roman', serif;
            font-style: italic;
            background: rgba(255,255,255,0.7);
            padding: 5px;
            border-radius: 4px;
            text-align: center;
            margin: 5px 0;
            font-weight: bold;
        }

        /* æ§åˆ¶å€ */
        .control-section {
            margin-top: auto;
            padding-top: 15px;
            border-top: 2px solid #eee;
        }

        .control-group {
            margin-bottom: 15px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 8px;
        }

        label {
            font-weight: bold;
            display: block;
            font-size: 0.95rem;
            margin-bottom: 5px;
        }

        input[type=range] {
            width: 100%;
            cursor: pointer;
        }

        .value-display {
            float: right;
            color: #666;
            font-weight: bold;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
            color: white;
        }

        #btnStart { background-color: var(--accent-green); }
        #btnStart:hover { background-color: #27ae60; }
        #btnStart.paused { background-color: var(--accent-orange); }
        
        #btnReset { background-color: #95a5a6; }
        #btnReset:hover { background-color: #7f8c8d; }

        #btnCalculate { 
            background-color: #34495e; 
            margin-top: 10px;
            width: 100%;
        }
        #btnCalculate:hover { background-color: #2c3e50; }

        /* å³å´é¢æ¿ */
        .visualization-main {
            flex: 2;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .vis-panel {
            background: var(--panel-bg);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        #phantomContainer {
            width: 100%;
            height: 220px;
            position: relative;
            background: #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #bdc3c7;
        }

        /* è…«ç˜¤æ¨£å¼ */
        .tumor {
            position: absolute;
            top: 50%;
            width: 50px;
            height: 50px;
            background-color: #8e44ad;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 15px #8e44ad;
            z-index: 1;
            transition: left 0.1s linear;
        }
        .tumor::after {
            content: "Tumor";
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            color: #8e44ad;
            font-weight: bold;
            font-size: 0.8rem;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .chart-container {
            flex: 1;
            position: relative;
            min-height: 200px;
        }

        .legend {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        .dot { width: 12px; height: 12px; display: inline-block; margin-right: 5px; border-radius: 50%; }

        /* ä½œè€…æ¨™ç±¤æ¨£å¼ */
        .author-footer {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 8px 16px;
            border-radius: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            font-weight: bold;
            color: #555;
            font-size: 0.9rem;
            z-index: 9999;
            border: 1px solid #ddd;
            pointer-events: none; /* è®“æ»‘é¼ å¯ä»¥ç©¿é€é»æ“Šä¸‹æ–¹çš„æ±è¥¿ */
        }

    </style>
</head>
<body>

    <h1>æ”¾å°„æ²»ç™‚ç‰©ç†åŸç†è¦–è¦ºåŒ–ï¼šå…‰å­ vs. è³ªå­</h1>

    <div class="container">
        <div class="sidebar">
            
            <div class="theory-section">
                <h2>ç†è«–åŸºç¤èˆ‡å…¬å¼</h2>
                
                <div class="theory-block xray-block">
                    <strong>å‚³çµ± X å…‰ (Photon)</strong>
                    <p>èƒ½é‡éš¨æ·±åº¦å‘ˆæŒ‡æ•¸è¡°æ¸›ï¼Œä¸”å—è·é›¢å¹³æ–¹åæ¯”å®šå¾‹å½±éŸ¿ã€‚</p>
                    <div class="formula">I(x) = I<sub>0</sub> Â· e<sup>-Î¼x</sup></div>
                    <div class="formula">I âˆ 1 / r<sup>2</sup></div>
                </div>

                <div class="theory-block proton-block">
                    <strong>è³ªå­æŸ (Proton)</strong>
                    <p>åˆ©ç”¨è¿´æ—‹åŠ é€Ÿå™¨çµ¦äºˆè³ªå­å‹•èƒ½ã€‚è³ªå­é€²å…¥äººé«”å¾Œé€Ÿåº¦è®Šæ…¢ï¼Œåœ¨åœæ­¢å‰é‡‹æ”¾æœ€å¤§èƒ½é‡ (å¸ƒæ‹‰æ ¼å³°)ã€‚</p>
                    <div class="formula">E<sub>k</sub> âˆ v<sup>2</sup> (åŠ é€Ÿ)</div>
                    <div class="formula">Stopping Power âˆ 1/v<sup>2</sup></div>
                </div>
            </div>

            <div class="control-section">
                <h2>äº’å‹•æ¨¡æ“¬æ§åˆ¶</h2>
                
                <div class="control-group" style="border-left: 4px solid #8e44ad;">
                    <label>è…«ç˜¤æ·±åº¦ (Target Depth) <span id="tumorVal" class="value-display">15.0 cm</span></label>
                    <input type="range" id="tumorSlider" min="2" max="28" step="0.1" value="15.0">
                </div>

                <div class="control-group" style="border-left: 4px solid var(--accent-red);">
                    <label>è³ªå­åœæ­¢æ·±åº¦ (Bragg Peak) <span id="energyVal" class="value-display">15.0 cm</span></label>
                    <input type="range" id="energySlider" min="2" max="28" step="0.1" value="15.0">
                </div>

                <div class="btn-group">
                    <button id="btnStart">â–¶ é–‹å§‹ç´¯ç©</button>
                    <button id="btnReset">âŸ² é‡ä¾†</button>
                </div>
                <p style="font-size: 0.8rem; color: #7f8c8d; margin-top: 5px;">* æŒ‰ä¸‹é–‹å§‹å¾Œï¼Œè§€å¯Ÿå°„ç·šå¦‚ä½•ç´¯ç©åŠ‘é‡ã€‚</p>
            </div>
        </div>

        <div class="visualization-main">
            
            <div class="vis-panel">
                <h3>1. äººé«”å…§å°„ç·šå‚³æ’­æ¨¡æ“¬ (å³æ™‚é‹ç®—)</h3>
                <div class="legend">
                    <span><span class="dot" style="background: var(--accent-blue);"></span>X å…‰ (Photon)</span>
                    <span><span class="dot" style="background: var(--accent-red);"></span>è³ªå­ (Proton)</span>
                    <span><span class="dot" style="background: #8e44ad;"></span>è…«ç˜¤</span>
                </div>
                
                <div id="phantomContainer">
                    <div id="tumorObj" class="tumor"></div>
                    <canvas id="beamCanvas"></canvas>
                    
                    <div style="position: absolute; bottom: 0; width: 100%; height: 20px; display: flex; justify-content: space-between; padding: 0 5px; color: #666; font-size: 0.8rem; border-top: 1px solid #ccc;">
                        <span>0cm</span><span>10cm</span><span>20cm</span><span>30cm</span>
                    </div>
                </div>
            </div>

            <div class="vis-panel" style="flex:1;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h3 style="margin:0;">2. äºŒç¶­åŠ‘é‡æ·±åº¦åˆ†æåœ– (Analysis)</h3>
                    <button id="btnCalculate" style="width: auto; padding: 5px 15px;">ğŸ“Š è¨ˆç®—åˆ†æåœ–è¡¨</button>
                </div>
                
                <div class="chart-container">
                    <canvas id="doseChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="author-footer">é†«å­¸ä¸€ æ—æ†æ¯…</div>

    <script>
        // --- è®Šæ•¸èˆ‡ DOM ---
        const tumorSlider = document.getElementById('tumorSlider');
        const energySlider = document.getElementById('energySlider');
        const tumorValDisplay = document.getElementById('tumorVal');
        const energyValDisplay = document.getElementById('energyVal');
        const tumorObj = document.getElementById('tumorObj');
        const beamCanvas = document.getElementById('beamCanvas');
        const ctxBeam = beamCanvas.getContext('2d');
        
        const btnStart = document.getElementById('btnStart');
        const btnReset = document.getElementById('btnReset');
        const btnCalculate = document.getElementById('btnCalculate');

        let animationId;
        let isRunning = false;
        let accumulationFactor = 0; // æ¨¡æ“¬åŠ‘é‡ç´¯ç©ç¨‹åº¦ (0 ~ 1.0)
        
        const MAX_DEPTH_CM = 30;
        
        // --- åˆå§‹åŒ–ç•«å¸ƒå°ºå¯¸ ---
        function resizeCanvas() {
            beamCanvas.width = beamCanvas.offsetWidth;
            beamCanvas.height = beamCanvas.offsetHeight;
            drawSimulation(); // é‡ç¹ª
        }
        window.addEventListener('resize', resizeCanvas);

        // --- æ ¸å¿ƒé‚è¼¯ï¼šæ›´æ–°ç‹€æ…‹ ---
        
        function updateState() {
            // æ›´æ–°æ–‡å­—æ•¸å€¼
            tumorValDisplay.textContent = parseFloat(tumorSlider.value).toFixed(1) + " cm";
            energyValDisplay.textContent = parseFloat(energySlider.value).toFixed(1) + " cm";

            // æ›´æ–°è…«ç˜¤ä½ç½® (CSS left %)
            const tumorPercent = (tumorSlider.value / MAX_DEPTH_CM) * 100;
            tumorObj.style.left = `${tumorPercent}%`;

            // é‡ç¹ªå°„ç·š
            drawSimulation();
        }

        // --- ç¹ªåœ–é‚è¼¯ï¼šæ¨¡æ“¬å°„ç·š ---
        function drawSimulation() {
            ctxBeam.clearRect(0, 0, beamCanvas.width, beamCanvas.height);
            
            if (accumulationFactor <= 0) return;

            const w = beamCanvas.width;
            const h = beamCanvas.height;
            
            // 1. ç¹ªè£½ X å…‰ (ä¸ŠåŠéƒ¨)
            const xrayGradient = ctxBeam.createLinearGradient(0, 0, w, 0);
            xrayGradient.addColorStop(0, `rgba(52, 152, 219, ${0.8 * accumulationFactor})`); 
            xrayGradient.addColorStop(0.3, `rgba(52, 152, 219, ${0.5 * accumulationFactor})`);
            xrayGradient.addColorStop(1, `rgba(52, 152, 219, ${0.2 * accumulationFactor})`);
            
            ctxBeam.fillStyle = xrayGradient;
            ctxBeam.fillRect(0, 20, w, h/2 - 40);

            // 2. ç¹ªè£½ è³ªå­æŸ (ä¸‹åŠéƒ¨) - ç²¾æº–å°é½Šç‰ˆ
            const peakCm = parseFloat(energySlider.value);
            const peakPx = (peakCm / MAX_DEPTH_CM) * w;
            
            const protonGradient = ctxBeam.createLinearGradient(0, 0, w, 0); 
            
            let peakRatio = peakPx / w;
            if (peakRatio > 1) peakRatio = 1;
            if (peakRatio < 0) peakRatio = 0;

            let rampStart = Math.max(0, peakRatio - 0.05);
            let falloffEnd = Math.min(1, peakRatio + 0.01);

            // è¨­å®šé¡è‰²ç¯€é» (Color Stops)
            protonGradient.addColorStop(0, `rgba(231, 76, 60, ${0.3 * accumulationFactor})`); 
            protonGradient.addColorStop(rampStart, `rgba(231, 76, 60, ${0.4 * accumulationFactor})`);
            // *** é—œéµï¼šå³°å€¼ (Bragg Peak) å°é½Š ***
            protonGradient.addColorStop(peakRatio, `rgba(231, 76, 60, ${1.0 * accumulationFactor})`);
            // æˆªæ­¢é»
            protonGradient.addColorStop(falloffEnd, `rgba(231, 76, 60, 0)`);

            ctxBeam.fillStyle = protonGradient;
            ctxBeam.fillRect(0, h/2 + 20, w, h/2 - 40);

            // ç¹ªè£½è™›ç·š (åœæ­¢æ·±åº¦æ¨™è¨˜)
            if (accumulationFactor > 0.1) {
                ctxBeam.beginPath();
                ctxBeam.moveTo(peakPx, h/2 + 15);
                ctxBeam.lineTo(peakPx, h - 15);
                ctxBeam.strokeStyle = `rgba(255, 0, 0, ${0.8 * accumulationFactor})`;
                ctxBeam.lineWidth = 2;
                ctxBeam.setLineDash([5, 3]);
                ctxBeam.stroke();
            }
        }

        // --- å‹•ç•«å¾ªç’° ---
        function animateLoop() {
            if (!isRunning) return;

            accumulationFactor += 0.005; 
            if (accumulationFactor >= 1.0) {
                accumulationFactor = 1.0;
                isRunning = false; 
                updateButtonState();
            }

            drawSimulation();
            
            if (isRunning) {
                requestAnimationFrame(animateLoop);
            }
        }

        // --- æŒ‰éˆ•äº‹ä»¶è™•ç† ---
        
        function updateButtonState() {
            if (isRunning) {
                btnStart.textContent = "â¸ æš«åœ";
                btnStart.classList.add('paused');
            } else {
                btnStart.textContent = accumulationFactor >= 1.0 ? "å®Œæˆ (å·²æ»¿)" : "â–¶ ç¹¼çºŒ";
                if(accumulationFactor === 0) btnStart.textContent = "â–¶ é–‹å§‹ç´¯ç©";
                btnStart.classList.remove('paused');
            }
        }

        btnStart.addEventListener('click', () => {
            if (accumulationFactor >= 1.0) return; 
            
            isRunning = !isRunning;
            updateButtonState();
            if (isRunning) animateLoop();
        });

        btnReset.addEventListener('click', () => {
            isRunning = false;
            accumulationFactor = 0;
            updateButtonState();
            drawSimulation();
            doseChart.data.datasets[0].data = [];
            doseChart.data.datasets[1].data = [];
            doseChart.update();
        });

        // æ»‘æ¡¿äº‹ä»¶
        tumorSlider.addEventListener('input', updateState);
        energySlider.addEventListener('input', updateState);

        // --- Chart.js åœ–è¡¨è¨ˆç®—èˆ‡ç¹ªè£½ ---
        
        function getXrayDose(depth) {
            let buildup = depth < 1.5 ? (0.6 + (depth/1.5)*0.4) : 1;
            let decay = Math.exp(-0.06 * (depth - 1.5));
            if (depth < 1.5) decay = 1;
            let invSquare = Math.pow(100 / (100 + depth), 2);
            return buildup * decay * invSquare * 100;
        }

        function getProtonDose(depth, peakDepth) {
            const baseDose = 30;
            const sigma = 0.6; 
            const peakHeight = 70;
            
            let gaussian = peakHeight * Math.exp(-Math.pow(depth - peakDepth, 2) / (2 * sigma * sigma));
            
            if (depth > peakDepth + sigma * 3) gaussian = 0;
            if (depth > peakDepth + 0.5) gaussian *= 0.1; 

            let slope = (depth / peakDepth) * 10;
            if (depth > peakDepth) slope = 10;

            let total = baseDose + slope + gaussian;
            if (depth > peakDepth + 1) return 0;
            return total;
        }

        const ctxChart = document.getElementById('doseChart').getContext('2d');
        const chartLabels = [];
        for(let i=0; i<=MAX_DEPTH_CM; i+=0.1) chartLabels.push(i.toFixed(1));

        const doseChart = new Chart(ctxChart, {
            type: 'line',
            data: {
                labels: chartLabels,
                datasets: [
                    {
                        label: 'å‚³çµ± X å…‰',
                        data: [],
                        borderColor: '#3498db',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.4
                    },
                    {
                        label: 'è³ªå­æŸ (å¸ƒæ‹‰æ ¼å³°)',
                        data: [],
                        borderColor: '#e74c3c',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: { duration: 1000 },
                scales: {
                    x: { title: { display: true, text: 'æ·±åº¦ (cm)' } },
                    y: { title: { display: true, text: 'ç›¸å°åŠ‘é‡ (%)' }, min: 0, max: 110 }
                }
            }
        });

        btnCalculate.addEventListener('click', () => {
            const peakDepth = parseFloat(energySlider.value);
            
            const xrayData = chartLabels.map(d => getXrayDose(parseFloat(d)));
            const protonData = chartLabels.map(d => getProtonDose(parseFloat(d), peakDepth));

            doseChart.data.datasets[0].data = xrayData;
            doseChart.data.datasets[1].data = protonData;
            doseChart.update();
        });

        resizeCanvas();
        updateState();

    </script>
</body>
</html>